#include <cstdio>
#include <cstdlib>
#include <cstring>

#include <sys/socket.h>
#include <sys/types.h>
#include <netdb.h>
#include <netinet/in.h>
#include <unistd.h>
#include <arpa/inet.h>

using namespace std;

#include "pracenjeStudenataProtokol.h"

int send_message(int sock, int messageType, const char *message) {
	
	//priprema header:
	
	int	message_length		= strlen(message),
		message_length_net	= htonl((unsigned int) message_length),
		messageType_net		= htonl((unsigned int) messageType);

	char	header[HEADER_SIZE + 1];
	
	sprintf(header, "%d%d", messageType_net, message_length_net);
	
	//salje header:
	
	int 	sent_total	= 0,
		last_sent	= 0;
		
	while (sent_total < HEADER_SIZE) {
		if (
			(last_sent = send(
				sock,
				header + sent_total,
				HEADER_SIZE - sent_total,
				0))
			== -1
		) {
			return UNSUCESSFULL;
		}
		sent_total += last_sent;
	}
	
	//salje poruku:
	
	sent_total	= 0;
	last_sent	= 0;
	
	while (sent_total < message_length) {
		if (
			(last_sent = send(
				sock,
				message + sent_total,
				message_length - sent_total,
				0))
			== -1
		) {
			return UNSUCESSFULL;
		}
		sent_total += last_sent;
	}
	return SUCESSFULL;
}

int receive_message(int sock, int *messageType, int *messageLength, char **message) {
	
	//prima header:
	
	int 	total_received		= 0,
		last_received		= 0;
		
	char	header[HEADER_SIZE];
	
	while (total_received < HEADER_SIZE) {
		if (
			(last_received = recv(
				sock,
				header + total_received,
				HEADER_SIZE - total_received,
				0))
			== -1
		) {
			return UNSUCESSFULL;
		}
	}
	
	//cita i formatira podatke iz headera:
	
	int 	messageType_net,
		messageLength_net;
		
	sscanf(header, "%d%d", messageType_net, messageLength_net);
	*messageType	= (int) ntohl((unsigned int) messageType_net);
	*messageLength	= (int) ntohl((unsigned int) messageLength_net);
	
	//cita poruku:
	
	*message = (char *) malloc((*messageLength + 1)*sizeof(char));
	
	total_received		= 0,
	last_received		= 0;
	
	while (total_received < *messageLength) {
		if (
			(last_received = recv(
				sock,
				*message + total_received,
				*messageLength - total_received,
				0))
			== -1
		) {
			return UNSUCESSFULL;
		}
	}
	(*message)[*messageLength] = '\0';
	
	return SUCESSFULL;
}
